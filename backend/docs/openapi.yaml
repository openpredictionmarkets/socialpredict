openapi: 3.0.3
info:
  title: SocialPredict API
  version: 0.1.0
  description: >
    HTTP contract for the SocialPredict backend service. This spec is generated
    from the Go handlers and DTOs under backend/server and backend/handlers.
servers:
  - url: http://localhost:8080
    description: Local dev server
tags:
  - name: Auth
    description: Authentication and session management.
  - name: Config
    description: Health and configuration endpoints.
  - name: Markets
    description: Market creation, listing, search, and resolution.
  - name: Bets
    description: Placing and selling bets.
  - name: Users
    description: Public and private user profile and financial data.
  - name: Metrics
    description: Platform-wide metrics and leaderboards.
  - name: Content
    description: CMS-powered homepage content.

paths:
  /health:
    get:
      tags: [Config]
      summary: Backend health check
      description: Simple liveness probe that returns "ok" when the backend is running.
      responses:
        '200':
          description: Backend is healthy.
          content:
            text/plain:
              schema:
                type: string
                example: ok

  /v0/login:
    post:
      tags: [Auth]
      summary: Authenticate user
      description: >
        Validates username and password and returns a JWT bearer token for subsequent
        authenticated requests.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Invalid JSON payload or validation failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid username or password.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Database access or token creation failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/home:
    get:
      tags: [Config]
      summary: Backend home
      description: Returns a simple JSON message to verify backend availability.
      responses:
        '200':
          description: Backend responded successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /v0/setup:
    get:
      tags: [Config]
      summary: Get economics configuration
      description: Returns the current economic configuration used by the backend.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Economics configuration returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Economics'
        '500':
          description: Failed to load or encode configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/setup/frontend:
    get:
      tags: [Config]
      summary: Get frontend configuration
      description: Returns minimal configuration values needed by the frontend, such as chart precision.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Frontend configuration returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FrontendConfig'
        '500':
          description: Failed to load or encode configuration.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets:
    get:
      tags: [Markets]
      summary: List markets
      description: >
        Returns markets with optional filtering by status and creator. When status is
        provided, results are backed by a status-specific query.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          required: false
          description: >
            Filter by market status. Accepted values are active, closed, resolved, and all
            (or omitted for all markets).
          schema:
            type: string
            enum: [active, closed, resolved, all]
        - in: query
          name: created_by
          required: false
          description: Only include markets created by the given username.
          schema:
            type: string
        - in: query
          name: limit
          required: false
          description: Maximum number of markets to return.
          schema:
            type: integer
            minimum: 1
            maximum: 100
        - in: query
          name: offset
          required: false
          description: Number of markets to skip before collecting results.
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Markets returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMarketsResponse'
        '400':
          description: Invalid status or pagination parameters.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while listing markets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Markets]
      summary: Create a market
      description: Creates a new prediction market for the authenticated user.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMarketRequest'
      responses:
        '201':
          description: Market created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketResponse'
        '400':
          description: Validation failed while creating the market.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or user not authorized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Password change required before creating markets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error during market creation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/search:
    get:
      tags: [Markets]
      summary: Search markets
      description: >
        Searches markets by question title with optional status filtering. Supports both
        "query" and legacy "q" parameters.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: query
          required: false
          description: Search query (preferred parameter name).
          schema:
            type: string
        - in: query
          name: q
          required: false
          description: Legacy search query parameter (used if "query" is not provided).
          schema:
            type: string
        - in: query
          name: status
          required: false
          description: Filter by market status; same accepted values as /v0/markets.
          schema:
            type: string
            enum: [active, closed, resolved, all]
        - in: query
          name: limit
          required: false
          description: Maximum number of primary results to return.
          schema:
            type: integer
            minimum: 1
        - in: query
          name: offset
          required: false
          description: Number of primary results to skip before collecting.
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Search completed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Missing query parameter or invalid status.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error during search.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/status:
    get:
      tags: [Markets]
      summary: List markets across all statuses
      description: Convenience endpoint equivalent to `/v0/markets?status=all`.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          required: false
          description: Maximum number of markets to return.
          schema:
            type: integer
            minimum: 1
            maximum: 100
        - in: query
          name: offset
          required: false
          description: Number of markets to skip before collecting results.
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Markets returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMarketsResponse'
        '400':
          description: Invalid pagination parameters.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while listing markets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/status/{status}:
    get:
      tags: [Markets]
      summary: List markets by status
      description: Returns markets filtered by a specific lifecycle status.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: status
          required: true
          description: >
            Market status to filter by. Accepted values are active, closed, resolved, and all.
          schema:
            type: string
            enum: [active, closed, resolved, all]
        - in: query
          name: limit
          required: false
          description: Maximum number of markets to return.
          schema:
            type: integer
            minimum: 1
            maximum: 100
        - in: query
          name: offset
          required: false
          description: Number of markets to skip before collecting results.
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Markets returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMarketsResponse'
        '400':
          description: Invalid or unsupported status value.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while listing markets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/{id}:
    get:
      tags: [Markets]
      summary: Get market details
      description: >
        Fetches a single market by its identifier, including probability history and
        aggregate statistics.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Market returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketDetailsResponse'
        '400':
          description: Invalid market ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching market details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/{id}/resolve:
    post:
      tags: [Markets]
      summary: Resolve a market
      description: Sets the final outcome for a market once it has concluded.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Numeric identifier of the market to resolve.
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveMarketRequest'
      responses:
        '204':
          description: Market resolved successfully; no content is returned.
        '400':
          description: Invalid market ID, resolution value, or market state.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or user not authorized to resolve the market.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Password change required before resolving markets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market or user not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Market already resolved or cannot be resolved in its current state.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error during resolution.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/{id}/leaderboard:
    get:
      tags: [Markets]
      summary: Get market leaderboard
      description: Ranks participants in a single market by profit and traded volume.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
        - in: query
          name: limit
          required: false
          description: Maximum number of rows to return.
          schema:
            type: integer
            minimum: 1
        - in: query
          name: offset
          required: false
          description: Number of rows to skip before collecting results.
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Leaderboard returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketLeaderboardResponse'
        '400':
          description: Invalid market ID or pagination parameters.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while computing leaderboard.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/{id}/projection:
    get:
      tags: [Markets]
      summary: Project market probability
      description: >
        Computes the projected probability for a market after a hypothetical bet,
        using the market identifier and bet parameters.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Projection computed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProbabilityProjectionResponse'
        '400':
          description: Invalid market ID or bet parameters.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while computing projection.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/marketprojection/{marketId}/{amount}/{outcome}:
    get:
      tags: [Markets]
      summary: Legacy market projection endpoint
      description: >
        Legacy route for computing a probability projection using path parameters
        instead of query parameters.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: marketId
          required: true
          schema:
            type: integer
            format: int64
        - in: path
          name: amount
          required: true
          schema:
            type: integer
        - in: path
          name: outcome
          required: true
          schema:
            type: string
            enum: [YES, NO]
      responses:
        '200':
          description: Projection computed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProbabilityProjectionResponse'
        '400':
          description: Invalid market ID, amount, or outcome.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while computing projection.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/bets/{marketId}:
    get:
      tags: [Bets, Markets]
      summary: List bets for a market
      description: Returns the bet history for a specific market.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: marketId
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Bets returned successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MarketBet'
        '400':
          description: Invalid market ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching bets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/positions/{marketId}:
    get:
      tags: [Markets, Users]
      summary: List user positions for a market
      description: Returns all user positions (YES/NO shares) in a specific market.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: marketId
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Positions returned successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MarketPosition'
        '400':
          description: Invalid market ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching positions.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/markets/positions/{marketId}/{username}:
    get:
      tags: [Markets, Users]
      summary: Get a user's position in a market
      description: Returns the holdings for a specific user in the given market.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: marketId
          required: true
          description: Numeric identifier of the market.
          schema:
            type: integer
            format: int64
        - in: path
          name: username
          required: true
          description: Username to query.
          schema:
            type: string
      responses:
        '200':
          description: Position returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MarketPosition'
        '400':
          description: Invalid market ID or username.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market or user not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching position.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/bet:
    post:
      tags: [Bets]
      summary: Place a bet
      description: Places a YES/NO bet on a market for the authenticated user.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaceBetRequest'
      responses:
        '201':
          description: Bet placed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaceBetResponse'
        '400':
          description: Invalid outcome, amount, or request body.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or password change required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Target market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Market is closed and does not accept new bets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Insufficient balance to place the bet.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while placing bet.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/sell:
    post:
      tags: [Bets]
      summary: Sell shares
      description: Sells an amount of YES/NO shares for the authenticated user and deposits the proceeds.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SellBetRequest'
      responses:
        '201':
          description: Sale processed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SellBetResponse'
        '400':
          description: Invalid sale request or amount/outcome.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or password change required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Market closed; sale not allowed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: No position, insufficient shares, or dust cap exceeded.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while processing sale.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/privateprofile:
    get:
      tags: [Users]
      summary: Get private profile
      description: Returns the authenticated userâ€™s private profile data.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Private profile returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateUserResponse'
        '401':
          description: Invalid or missing token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching profile.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/profilechange/description:
    post:
      tags: [Users]
      summary: Update profile description
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangeDescriptionRequest'
      responses:
        '200':
          description: Description updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateUserResponse'
        '400':
          description: Invalid request body or validation failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while updating description.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/profilechange/displayname:
    post:
      tags: [Users]
      summary: Update display name
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangeDisplayNameRequest'
      responses:
        '200':
          description: Display name updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateUserResponse'
        '400':
          description: Invalid request body or validation failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while updating display name.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/profilechange/emoji:
    post:
      tags: [Users]
      summary: Update personal emoji
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangeEmojiRequest'
      responses:
        '200':
          description: Personal emoji updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateUserResponse'
        '400':
          description: Invalid request body or validation failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while updating emoji.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/profilechange/links:
    post:
      tags: [Users]
      summary: Update personal links
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePersonalLinksRequest'
      responses:
        '200':
          description: Personal links updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivateUserResponse'
        '400':
          description: Invalid request body or validation failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while updating personal links.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/changepassword:
    post:
      tags: [Users]
      summary: Change account password
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Password changed successfully.
          content:
            text/plain:
              schema:
                type: string
                example: Password changed successfully
        '400':
          description: Invalid request body or password requirements not met.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or missing token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while changing password.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/userinfo/{username}:
    get:
      tags: [Users]
      summary: Get public user info
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          description: Username of the profile to fetch.
          schema:
            type: string
      responses:
        '200':
          description: Public profile returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicUserResponse'
        '400':
          description: Username missing or invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching public user.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/userposition/{marketId}:
    get:
      tags: [Users, Markets]
      summary: Get authenticated user's position in a market
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: marketId
          required: true
          description: Market identifier.
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Position returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPosition'
        '400':
          description: Invalid market ID.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Market or user not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching user position.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/usercredit/{username}:
    get:
      tags: [Users]
      summary: Get user credit
      description: Returns the user's available credit limit, treating missing users as max debt.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          description: Username to evaluate for credit availability.
          schema:
            type: string
      responses:
        '200':
          description: Credit calculated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserCreditResponse'
        '400':
          description: Username missing or invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to calculate user credit.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/admin/createuser:
    post:
      tags: [Users]
      summary: Create a new user (admin)
      description: >
        Admin-only endpoint that creates a new REGULAR user with a generated password.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminCreateUserRequest'
      responses:
        '200':
          description: User created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminCreateUserResponse'
        '400':
          description: Invalid username or username/display name/email/API key already in use.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or token invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Admin privileges required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to create user or hash password.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/portfolio/{username}:
    get:
      tags: [Users]
      summary: Get user portfolio
      description: Returns the markets and share counts for a user's portfolio.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          description: Username whose portfolio should be returned.
          schema:
            type: string
      responses:
        '200':
          description: Portfolio returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioResponse'
        '400':
          description: Username missing or invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while fetching portfolio.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/users/{username}/financial:
    get:
      tags: [Users]
      summary: Get user financial snapshot
      description: Returns a map of financial metrics (e.g., balances and exposures) by key.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: username
          required: true
          description: Username whose financial snapshot is requested.
          schema:
            type: string
      responses:
        '200':
          description: Financial snapshot returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserFinancialResponse'
        '400':
          description: Username missing or invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to generate financial snapshot.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/stats:
    get:
      tags: [Metrics]
      summary: Get platform stats
      description: Returns aggregate stats and the current economics configuration.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Stats returned successfully.
          content:
            application/json:
              schema:
                type: object
        '500':
          description: Failed to compute stats.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/system/metrics:
    get:
      tags: [Metrics]
      summary: Get system metrics
      description: Computes money creation/utilization metrics for auditing the economy.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Metrics returned successfully.
          content:
            application/json:
              schema:
                type: object
        '500':
          description: Failed to compute metrics.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/global/leaderboard:
    get:
      tags: [Metrics]
      summary: Get global leaderboard
      description: Returns a leaderboard ranking users by profitability across all markets.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Global leaderboard returned successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GlobalLeaderboardEntry'
        '500':
          description: Failed to compute global leaderboard.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v0/content/home:
    get:
      tags: [Content]
      summary: Get public homepage content
      description: Retrieves CMS-configured homepage content.
      responses:
        '200':
          description: Homepage content returned successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HomeContent'
        '404':
          description: Homepage content not found.
          content:
            text/plain:
              schema:
                type: string

  /v0/admin/content/home:
    put:
      tags: [Content]
      summary: Update homepage content
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HomeContentUpdateRequest'
      responses:
        '200':
          description: Homepage content updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HomeContent'
        '400':
          description: Invalid request body or update failure.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed or token invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Admin privileges required.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected server error while updating content.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string

    LoginResponse:
      type: object
      required: [token, username, usertype, mustChangePassword]
      properties:
        token:
          type: string
        username:
          type: string
        usertype:
          type: string
        mustChangePassword:
          type: boolean

    CreateMarketRequest:
      type: object
      required: [questionTitle, outcomeType, resolutionDateTime]
      properties:
        questionTitle:
          type: string
          maxLength: 160
        description:
          type: string
          maxLength: 2000
        outcomeType:
          type: string
        resolutionDateTime:
          type: string
          format: date-time
        yesLabel:
          type: string
          maxLength: 20
        noLabel:
          type: string
          maxLength: 20

    MarketResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        questionTitle:
          type: string
        description:
          type: string
        outcomeType:
          type: string
        resolutionDateTime:
          type: string
          format: date-time
        creatorUsername:
          type: string
        yesLabel:
          type: string
        noLabel:
          type: string
        status:
          type: string
        isResolved:
          type: boolean
        resolutionResult:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreatorResponse:
      type: object
      properties:
        username:
          type: string
        personalEmoji:
          type: string
        displayname:
          type: string

    MarketOverviewResponse:
      type: object
      properties:
        market:
          $ref: '#/components/schemas/MarketResponse'
        creator:
          $ref: '#/components/schemas/CreatorResponse'
        lastProbability:
          type: number
          format: float
        numUsers:
          type: integer
        totalVolume:
          type: integer
          format: int64
        marketDust:
          type: integer
          format: int64

    ListMarketsResponse:
      type: object
      properties:
        markets:
          type: array
          items:
            $ref: '#/components/schemas/MarketOverviewResponse'
        total:
          type: integer

    MarketDetailsResponse:
      type: object
      properties:
        market:
          $ref: '#/components/schemas/PublicMarketResponse'
        creator:
          $ref: '#/components/schemas/CreatorResponse'
        probabilityChanges:
          type: array
          items:
            $ref: '#/components/schemas/ProbabilityChange'
        numUsers:
          type: integer
        totalVolume:
          type: integer
          format: int64
        marketDust:
          type: integer
          format: int64

    PublicMarketResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        questionTitle:
          type: string
        description:
          type: string
        outcomeType:
          type: string
        resolutionDateTime:
          type: string
          format: date-time
        finalResolutionDateTime:
          type: string
          format: date-time
        utcOffset:
          type: integer
        isResolved:
          type: boolean
        resolutionResult:
          type: string
        initialProbability:
          type: number
          format: float
        creatorUsername:
          type: string
        createdAt:
          type: string
          format: date-time
        yesLabel:
          type: string
        noLabel:
          type: string

    ProbabilityChange:
      type: object
      properties:
        probability:
          type: number
          format: float
        timestamp:
          type: string
          format: date-time

    SearchResponse:
      type: object
      properties:
        primaryResults:
          type: array
          items:
            $ref: '#/components/schemas/MarketOverviewResponse'
        fallbackResults:
          type: array
          items:
            $ref: '#/components/schemas/MarketOverviewResponse'
        query:
          type: string
        primaryStatus:
          type: string
        primaryCount:
          type: integer
        fallbackCount:
          type: integer
        totalCount:
          type: integer
        fallbackUsed:
          type: boolean

    ResolveMarketRequest:
      type: object
      required: [resolution]
      properties:
        resolution:
          type: string
          enum: [yes, no]

    MarketLeaderboardResponse:
      type: object
      properties:
        marketId:
          type: integer
          format: int64
        leaderboard:
          type: array
          items:
            $ref: '#/components/schemas/LeaderboardRow'
        total:
          type: integer

    LeaderboardRow:
      type: object
      properties:
        username:
          type: string
        profit:
          type: integer
          format: int64
        currentValue:
          type: integer
          format: int64
        totalSpent:
          type: integer
          format: int64
        position:
          type: string
        yesSharesOwned:
          type: integer
          format: int64
        noSharesOwned:
          type: integer
          format: int64
        rank:
          type: integer

    ProbabilityProjectionResponse:
      type: object
      properties:
        marketId:
          type: integer
          format: int64
        currentProbability:
          type: number
          format: float
        projectedProbability:
          type: number
          format: float
        amount:
          type: integer
          format: int64
        outcome:
          type: string

    PlaceBetRequest:
      type: object
      properties:
        marketId:
          type: integer
        amount:
          type: integer
          format: int64
        outcome:
          type: string

    PlaceBetResponse:
      type: object
      properties:
        username:
          type: string
        marketId:
          type: integer
        amount:
          type: integer
          format: int64
        outcome:
          type: string
        placedAt:
          type: string
          format: date-time

    SellBetRequest:
      type: object
      properties:
        marketId:
          type: integer
        amount:
          type: integer
          format: int64
        outcome:
          type: string

    SellBetResponse:
      type: object
      properties:
        username:
          type: string
        marketId:
          type: integer
        sharesSold:
          type: integer
          format: int64
        saleValue:
          type: integer
          format: int64
        dust:
          type: integer
          format: int64
        outcome:
          type: string
        transactionAt:
          type: string
          format: date-time

    MarketPosition:
      type: object
      properties:
        username:
          type: string
        yesSharesOwned:
          type: integer
          format: int64
        noSharesOwned:
          type: integer
          format: int64
        value:
          type: integer
          format: int64

    UserPosition:
      type: object
      properties:
        username:
          type: string
        marketId:
          type: integer
          format: int64
        yesSharesOwned:
          type: integer
          format: int64
        noSharesOwned:
          type: integer
          format: int64
        value:
          type: integer
          format: int64
        totalSpent:
          type: integer
          format: int64
        totalSpentInPlay:
          type: integer
          format: int64
        isResolved:
          type: boolean
        resolutionResult:
          type: string

    MarketBet:
      type: object
      properties:
        username:
          type: string
        marketId:
          type: integer
          format: int64
        amount:
          type: integer
          format: int64
        outcome:
          type: string
        placedAt:
          type: string
          format: date-time

    PrivateUserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        username:
          type: string
        displayname:
          type: string
        usertype:
          type: string
        initialAccountBalance:
          type: integer
          format: int64
        accountBalance:
          type: integer
          format: int64
        personalEmoji:
          type: string
        description:
          type: string
        personalink1:
          type: string
        personalink2:
          type: string
        personalink3:
          type: string
        personalink4:
          type: string
        email:
          type: string
        apiKey:
          type: string
        mustChangePassword:
          type: boolean

    PublicUserResponse:
      type: object
      properties:
        username:
          type: string
        displayname:
          type: string
        usertype:
          type: string
        initialAccountBalance:
          type: integer
          format: int64
        accountBalance:
          type: integer
          format: int64
        personalEmoji:
          type: string
        description:
          type: string
        personalink1:
          type: string
        personalink2:
          type: string
        personalink3:
          type: string
        personalink4:
          type: string

    UserCreditResponse:
      type: object
      properties:
        credit:
          type: integer
          format: int64

    PortfolioItem:
      type: object
      properties:
        marketId:
          type: integer
        questionTitle:
          type: string
        yesSharesOwned:
          type: integer
          format: int64
        noSharesOwned:
          type: integer
          format: int64
        lastBetPlaced:
          type: string
          format: date-time

    PortfolioResponse:
      type: object
      properties:
        portfolioItems:
          type: array
          items:
            $ref: '#/components/schemas/PortfolioItem'
        totalSharesOwned:
          type: integer
          format: int64

    AdminCreateUserRequest:
      type: object
      properties:
        username:
          type: string
          description: Desired username for the new user.

    AdminCreateUserResponse:
      type: object
      properties:
        message:
          type: string
        username:
          type: string
        password:
          type: string
        usertype:
          type: string

    UserFinancialResponse:
      type: object
      properties:
        financial:
          type: object
          additionalProperties:
            type: integer
            format: int64

    ChangeDescriptionRequest:
      type: object
      properties:
        description:
          type: string

    ChangeDisplayNameRequest:
      type: object
      properties:
        displayName:
          type: string

    ChangeEmojiRequest:
      type: object
      properties:
        emoji:
          type: string

    ChangePersonalLinksRequest:
      type: object
      properties:
        personalLink1:
          type: string
        personalLink2:
          type: string
        personalLink3:
          type: string
        personalLink4:
          type: string

    ChangePasswordRequest:
      type: object
      properties:
        currentPassword:
          type: string
        newPassword:
          type: string

    Economics:
      type: object
      properties:
        marketcreation:
          $ref: '#/components/schemas/MarketCreation'
        marketincentives:
          $ref: '#/components/schemas/MarketIncentives'
        user:
          $ref: '#/components/schemas/UserEconomics'
        betting:
          $ref: '#/components/schemas/Betting'

    MarketCreation:
      type: object
      properties:
        initialMarketProbability:
          type: number
          format: float
        initialMarketSubsidization:
          type: integer
          format: int64
        initialMarketYes:
          type: integer
          format: int64
        initialMarketNo:
          type: integer
          format: int64
        minimumFutureHours:
          type: number
          format: float

    MarketIncentives:
      type: object
      properties:
        createMarketCost:
          type: integer
          format: int64
        traderBonus:
          type: integer
          format: int64

    UserEconomics:
      type: object
      properties:
        initialAccountBalance:
          type: integer
          format: int64
        maximumDebtAllowed:
          type: integer
          format: int64

    BetFees:
      type: object
      properties:
        initialBetFee:
          type: integer
          format: int64
        buySharesFee:
          type: integer
          format: int64
        sellSharesFee:
          type: integer
          format: int64

    Betting:
      type: object
      properties:
        minimumBet:
          type: integer
          format: int64
        maxDustPerSale:
          type: integer
          format: int64
        betFees:
          $ref: '#/components/schemas/BetFees'

    FrontendConfig:
      type: object
      properties:
        charts:
          $ref: '#/components/schemas/FrontendCharts'

    FrontendCharts:
      type: object
      properties:
        sigFigs:
          type: integer

    GlobalLeaderboardEntry:
      type: object
      properties:
        username:
          type: string
        totalProfit:
          type: integer
          format: int64
        totalCurrentValue:
          type: integer
          format: int64
        totalSpent:
          type: integer
          format: int64
        activeMarkets:
          type: integer
        resolvedMarkets:
          type: integer
        earliestBet:
          type: string
          format: date-time
        rank:
          type: integer

    HomeContent:
      type: object
      properties:
        title:
          type: string
        format:
          type: string
        html:
          type: string
        markdown:
          type: string
        version:
          type: integer
          format: int64
        updatedAt:
          type: string
          format: date-time

    HomeContentUpdateRequest:
      type: object
      properties:
        title:
          type: string
        format:
          type: string
        markdown:
          type: string
        html:
          type: string
        version:
          type: integer
          format: int64
