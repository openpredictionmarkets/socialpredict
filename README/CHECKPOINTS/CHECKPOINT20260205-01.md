# Extraction Plan: Auth, Wallet, DTO Packages (2026-02-05)

Goal: separate concerns in `backend/internal/domain/users/models.go` by carving out `auth`, `wallet`, and DTO packages while keeping changes incremental and compile-safe.

## Current Problems (from code)

`backend/internal/domain/users/models.go` contains:

- Core identity: `User` (id, username, display name, email, user type)
- Wallet/account: `InitialAccountBalance`, `AccountBalance`
- Auth: `APIKey`, `MustChangePassword`, plus `Credentials` in `validation.go`
- DTOs: `PublicUser`, `PrivateProfile`, `UserCreateRequest`, `UserUpdateRequest`
- Market/portfolio read models: `UserBet`, `MarketUserPosition`, `Portfolio*`, `UserMarket`

This file still mixes domain, auth, and transport concerns, even after validation was moved.

## Concrete Extraction Plan (Incremental)

### Phase 0 – Inventory and compile guard (no behavior change)

1. Inventory usage of all structs in `backend/internal/domain/users/models.go`.
2. Add a small compile-time assert to detect if new wallet/auth fields sneak back into `users.User` after extraction (post-split).

### Phase 1 – Auth package (low risk, self-contained)

Create `backend/internal/domain/auth` and move auth types here:

- Move `Credentials` (currently in `users/validation.go`) to `auth/credentials.go`
- Move `APIKey` (currently in `users/validation.go`) to `auth/apikey.go`
- Update imports/usages to reference `auth.Credentials` and `auth.APIKey`
- Remove auth validation from `users` package

Notes:
- This decouples credential validation logic from user domain.
- `users.User` should no longer embed auth fields directly after Phase 2.

### Phase 2 – Wallet/account package

Create `backend/internal/domain/wallet`:

- Introduce `Account` with `UserID`, `InitialBalance`, `Balance`, and currency if needed
- Introduce behaviors: `Credit`, `Debit`, `CanAfford`
- Replace usages of `User.InitialAccountBalance` and `User.AccountBalance` with `wallet.Account`
- Update any repo/storage code to persist account data separately

After this, remove `InitialAccountBalance` and `AccountBalance` from `users.User`.

### Phase 3 – DTO extraction (transport layer)

Create `backend/internal/transport/dto/users` (or similar) and move:

- `PublicUser`
- `PrivateProfile`
- `UserCreateRequest`
- `UserUpdateRequest`

Update handlers/controllers to import DTO types from the transport layer.

Result: `users` package holds only core identity + profile fields.

### Phase 4 – Market/portfolio read models

Move `UserBet`, `MarketUserPosition`, `PortfolioItem`, `Portfolio`, `UserMarket` to:

- `backend/internal/domain/markets` or `backend/internal/domain/portfolio`

Only keep user ID references inside these read models.

### Phase 5 – Clean-up and guardrails

- Remove any leftover duplicated link fields (or consolidate into a `PersonalLinks` type in `users`)
- Add tests or lint to prevent `users.User` from including auth or wallet fields
- Document the domain boundaries in README or internal docs

## Start Carving Now: Proposed Implementation Order

I recommend starting with Phases 1–3, in order. They’re mostly mechanical moves with minimal business logic changes.

## First Pass Tasks (what I can do next)

1. Search and list all references to `Credentials`, `APIKey`, and `User.*Balance`
2. Create `backend/internal/domain/auth` and migrate types + validation
3. Create `backend/internal/domain/wallet` with placeholder struct + methods
4. Move DTOs into `backend/internal/transport/dto/users`
5. Update call sites to new packages and fix compilation

If you want me to start now, I’ll begin with a reference inventory (rg) and then apply Phase 1.
