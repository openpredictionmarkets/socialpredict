# market balance mutations through wallet.Service

## Implementation Plan (Concrete Commit Boundaries)

refactor(bets): add wallet port + legacy adapter (no behavior change)
Touch service.go and add a wallet-facing interface (ValidateBalance, Debit, Credit), plus a temporary adapter that wraps current UserService.
Keep bets.NewService(...) signature stable for now and default to adapter internally.
Run go test ./internal/domain/bets/....

DONE

refactor(bets): use wallet.ValidateBalance in Place flow
Touch bet_place.go and stop checking user.AccountBalance directly.
Replace balance guard call with wallet validation and map wallet errors to bets.ErrInsufficientBalance.
Update service_test.go for new mock expectations.
Run go test ./internal/domain/bets/....

DONE

refactor(bets): use wallet Debit/Credit in ledger charge/sell + compensation
Touch bet_support.go and move ChargeAndRecord / CreditSale mutations from users.ApplyTransaction to wallet debit/credit calls.
Preserve rollback compensation semantics on repository failure.
Update service_helpers_test.go and service_test.go.
Run go test ./internal/domain/bets/....

DONE

refactor(markets): split profile and wallet ports + legacy adapter (no behavior change)
Touch interfaces.go and service.go.
Split current UserService dependency into creator/profile concerns and wallet concerns, with a temporary adapter over existing users service.
Run go test ./internal/domain/markets/....

DONE

refactor(markets): route CreateMarket balance deduction to wallet.Debit
Touch market_creation.go.
Replace ValidateUserBalance + DeductBalance with wallet debit call using CreateMarketCost and MaximumDebtAllowed; map wallet insufficient-balance to markets.ErrInsufficientBalance.
Add/update focused create-market tests (new file if needed, e.g. market_creation_test.go).
Run go test ./internal/domain/markets/....

DONE

payouts to wallet.Credit
Touch market_resolution.go.
Replace ApplyTransaction(..., Refund/Win) with wallet credit calls using wallet tx types.
Update service_resolve_test.go and related no-op mocks.
Run go test ./internal/domain/markets/....

DONE

wiring(app): initialize wallet repo/service and inject into bets/markets
Touch container.go.
Instantiate backend/internal/repository/wallet + backend/internal/domain/wallet service and pass it into bets/markets constructors.
Keep adapters available until all tests are migrated.
Run go test ./internal/app/... ./internal/domain/bets/... ./internal/domain/markets/....

DONE

test(integration): migrate balance integration tests to wallet-backed wiring
Touch balance_integration_test.go.
Build services with real wallet repo/service in integration setup instead of relying on users transaction methods.
Run go test ./internal/domain -run BalanceIntegration.

cleanup: remove bets/markets dependency on users transaction mutations
Remove now-unused mutation methods from bets/markets dependency interfaces and delete temporary adapters.
Keep users transaction methods only if still needed by non-bets/markets code; otherwise deprecate/remove in follow-up.
Run go test ./internal/domain/bets/... ./internal/domain/markets/... ./handlers/....

docs: checkpoint update + boundary notes
Touch CHECKPOINT20260205-01.md and optionally CHECKPOINT20260207-01.md.
Record that bet/market mutations now flow through wallet service and list remaining cleanup (if any).
Final run: go test ./....

Definition of Done

No ApplyTransaction, ValidateUserBalance, or DeductBalance calls remain in bets/markets domain paths.
Bet and market balance mutations are executed through wallet.Service.
Existing HTTP behavior and error mapping for insufficient balance remains unchanged.