📋 PROJECT PLAN: Real-Time Historical User Financials (Tabbi-Ready)
📌 GOAL
Implement an API endpoint that returns a per-user time series of daily financial snapshots by replaying historical data for each market and resolving user share values and balance at the end of each day (00:00 server/server-local time).

🧱 DESIGN CONSTRAINTS
✅ Fully stateless: no tables, no writes

✅ Functional: pure data transformations

✅ On-demand: computed only when user requests graphs

✅ Reuses existing code: CalculateMarketPositions_WPAM_DBPM stays untouched

✅ Cleanly slices input bet and probability data before passing to valuation logic

🧪 OUTPUT FORMAT
New API:

bash
Copy
Edit
GET /v0/users/{username}/financials/history
Returns:

json
Copy
Edit
{
  "username": "jess",
  "snapshots": [
    {
      "date": "2025-07-25",
      "accountBalance": 80,
      "equity": 100,
      "totalProfits": 70,
      "amountBorrowed": 0
    },
    {
      "date": "2025-07-26",
      ...
    }
  ]
}
These values are based on daily simulation of:

Bet/bonus/transaction history

Probability values from market snapshots

Account balance up to that point

🔧 IMPLEMENTATION STEPS
1. 🔍 Add New Endpoint Handler
📁 handlers/users/history.go

go
Copy
Edit
func GetUserFinancialHistory(w http.ResponseWriter, r *http.Request) {
	// 1. Extract username
	// 2. Load all bets and transactions for that user
	// 3. Identify unique days (truncate to midnight server time)
	// 4. For each day:
	//    a. Slice bets and probabilities to that day
	//    b. Compute positions using WPAM_DBPM
	//    c. Derive snapshot: balance, equity, profits, debt
	// 5. Return as JSON array
}
2. 📆 Time Slicing Utilities
📁 handlers/math/financials/slicing.go

go
Copy
Edit
func FilterBetsAndProbsAsOf(
	bets []models.Bet,
	probs []wpam.ProbabilityChange,
	asOf time.Time,
) ([]models.Bet, []wpam.ProbabilityChange) {
	var filteredBets []models.Bet
	for _, b := range bets {
		if b.PlacedAt.Before(asOf) || b.PlacedAt.Equal(asOf) {
			filteredBets = append(filteredBets, b)
		}
	}
	var filteredProbs []wpam.ProbabilityChange
	for _, p := range probs {
		if p.Timestamp.Before(asOf) || p.Timestamp.Equal(asOf) {
			filteredProbs = append(filteredProbs, p)
		}
	}
	return filteredBets, filteredProbs
}
3. 🧮 Computation Loop per Market per Day
For each unique day:

Rebuild the account balance using bets and transactions up to that day

For each market the user bet in:

Get full bet history and probability history

Use FilterBetsAndProbsAsOf(...)

Inject into positions.CalculateMarketPositions_WPAM_DBPM_FromSlice(...)

Aggregate the returned []MarketPosition for that day

4. 📊 Derived Metrics
For each day D:

Metric	Calculation
amountInPlay	sum(position.Value)
tradingProfits	sum(position.Value - position.TotalSpent)
workProfits	sum(amount) of WorkReward, Bounty transactions before D
retainedEarnings	accountBalance - amountInPlay
amountBorrowed	-accountBalance if negative
equity	retainedEarnings + amountInPlay - amountBorrowed
totalProfits	tradingProfits + workProfits

5. 🧪 Add Tests
📁 handlers/users/history_test.go

Use modelstesting.NewFakeDB()

Generate fake data using:

GenerateUser

GenerateBet

Custom slice of ProbabilityChange

Insert models.Transaction rows

Confirm financial snapshots match expected metrics over 2–3 day range

📈 Use in Tabbi
These fields can feed 3 charts:

Chart	Source Fields
Cash Profitability	accountBalance or totalProfits
Equity (Valuation)	equity
Debt Tracking	amountBorrowed

✅ Deliverables
/v0/users/{username}/financials/history API

Pure Go in-memory snapshot engine

Slicing logic separate from valuation logic

Fully tested with synthetic data