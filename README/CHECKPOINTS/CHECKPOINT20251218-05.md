## /markets/service.go evaluation of SRP

### SRP Drift

* backend/internal/domain/markets/service.go (lines 102-127) defines a single ServiceInterface/Service that spans market creation, read APIs, search, settlement, payouts, analytics, user-facing projections, and validation. Each concern has its own reason to change (business rules, math algorithms, user finance policy, query UX) so keeping them coupled in one 1K-line type violates SRP before touching any method specifics.

### Lifecycle & Finance Coupling

* CreateMarket (backend/internal/domain/markets/service.go (lines 139-222)) bundles request validation, label normalization, user existence checks, date-policy enforcement, balance enforcement, wallet debiting, and repository persistence. Every policy tweak (label defaults, pricing, debt caps) now forces edits to the same method, breaching SRP.

* ensureCreateMarketBalance (backend/internal/domain/markets/service.go (lines 217-222)) embeds wallet business rules (debt limits, cost deduction) inside the markets service rather than delegating to a financial/billing component.

* ResolveMarket, refundMarketBets, and payoutWinningPositions (backend/internal/domain/markets/service.go (lines 474-549)) mix authorization, state transitions, repo persistence, and direct user transactions. Settlement math or payout transaction types should live in a settlement/payment service so changes there don’t ripple through general market orchestration.

* SetCustomLabels (backend/internal/domain/markets/service.go (lines 168-183)) performs both validation policy and persistence in one method, so label policy tweaks require touching service orchestration logic.

### Search & Listing Responsibilities

* SearchMarkets plus helpers (backend/internal/domain/markets/service.go (lines 378-472)) interleave input validation, filter normalization, fallback heuristics, deduplication, and DTO assembly. Search heuristics (“<=5 results triggers fallback”, dedupe maps) form their own reason to change apart from market orchestration.

* ListActiveMarkets, ListClosedMarkets, and ListResolvedMarkets (backend/internal/domain/markets/service.go (lines 552-577)) reimplement the same filtering logic in three functions. These are presentation conveniences that belong in a query adapter rather than the domain service.

* ListByStatus (backend/internal/domain/markets/service.go (lines 610-632)) mixes pagination validation with repository delegation, so pagination policy shifts force market-domain edits instead of an infra layer.

### Analytics, Reporting & Math

* GetMarketOverviews/GetMarketDetails (backend/internal/domain/markets/service.go (lines 265-329)) aggregate creator summaries, probability histories, dust/volume math, and unique user counts. These analytics/calculation concerns differ from CRUD orchestration and should sit in a projection/analytics service to honor SRP.

* Helper math like convertToModelBets, countUniqueUsers, marketSnapshotFromModel, and pagination utilities (backend/internal/domain/markets/service.go (lines 345-376), 716-755) are cross-cutting utilities embedded in the service, forcing the service to change whenever data-shaping logic evolves.
GetMarketLeaderboard with paginateProfitability/mapLeaderboardRows (backend/internal/domain/markets/service.go (lines 634-755)) mixes domain retrieval, pagination rules, and DTO mapping for leaderboard rendering—again, a separate projection responsibility.

* ProjectProbability, validateProbabilityRequest, validateMarketForProjection, calculateProbabilityProjection, and normalizeOutcome (backend/internal/domain/markets/service.go (lines 672-820)) couple request validation, market-state checks, bet aggregation, and WPAM probability math into the main service. Probability modeling is a self-contained responsibility.

* CalculateMarketVolume (backend/internal/domain/markets/service.go (lines 823-840)) and GetMarketBets with all sorting/probability matching helpers (backend/internal/domain/markets/service.go (lines 851-931)) implement reporting/visualization logic that should be isolated. Changes to how bets are displayed or probabilities are interpolated now modify the primary service type.

### Validation Layer Mixups

* Both unexported and exported validation methods (validateQuestionTitle vs ValidateQuestionTitle, validateDescription vs ValidateDescription, validateCustomLabels vs ValidateLabels in backend/internal/domain/markets/service.go (lines 973-1045)) duplicate the same logic, forcing the market service to act as the validation library and to change twice whenever rules evolve.

* ValidateMarketResolutionTime (backend/internal/domain/markets/service.go (lines 1047-1058)) embeds scheduling policy (minimum hours ahead) directly in the service rather than a dedicated validator/config component, so changing the timing requirement again hits this file.

Implications

* Because each of these disparate responsibilities is centralized here, any tweak in user balance rules, search UX, statistical calculations, or API validation forces modifications to the same Service. Splitting the file into targeted services—creation, settlement/finance, search/query, analytics/reporting, and validation—would align with SRP and confine future changes to the concern they affect.