Template PROD allowedHosts in Vite using DOMAIN (plus optional PROD_EXTRA_ALLOWED) from your deploy .env.

Keep DEV allowedHosts static.

Bake the rendered vite.config.mjs into the prod image during ./SocialPredict install (prod).

No Dockerfile edits needed (render happens before docker build).

ðŸ—‚ï¸ File Changes
1) frontend/vite.config.mjs.template
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// DEV stays fixed â€” no templating
const DEV_ALLOWED = ['frontend', 'localhost', '127.0.0.1']

// PROD is injected at build-time by scripts/prod/env_writer_prod.sh
// It becomes a concrete JS array literal like: ["brierfoxforecast.com", "www.brierfoxforecast.com"]
const PROD_ALLOWED = [__PROD_ALLOWED_HOSTS__]

export default defineConfig(({ mode }) => {
  const isProd = mode === 'production'
  const allowed = isProd ? PROD_ALLOWED.filter(Boolean) : DEV_ALLOWED

  return {
    server: {
      host: '0.0.0.0',
      allowedHosts: allowed,
    },
    preview: { allowedHosts: allowed },
    build: {
      outDir: 'build',
      commonjsOptions: { transformMixedEsModules: true },
    },
    plugins: [react()],
    css: { target: 'async' },
  }
})

2) scripts/prod/env_writer_prod.sh
#!/usr/bin/env bash
set -euo pipefail

# Render PROD allowedHosts into frontend/vite.config.mjs from the template,
# using DOMAIN (and optional PROD_EXTRA_ALLOWED) from your deploy env file.

# Usage:
#   scripts/prod/env_writer_prod.sh /absolute/path/to/.env
#   # or rely on ENV_PATH env var:
#   ENV_PATH=/root/socialpredict-deploy/.env scripts/prod/env_writer_prod.sh

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
TPL="${ROOT_DIR}/frontend/vite.config.mjs.template"
OUT="${ROOT_DIR}/frontend/vite.config.mjs"

ENV_FILE="${1:-${ENV_PATH:-}}"
if [[ -z "${ENV_FILE}" || ! -f "${ENV_FILE}" ]]; then
  echo "ERROR: Supply path to deploy .env (arg #1) or set ENV_PATH to a valid file." >&2
  exit 1
fi

# shellcheck disable=SC1090
. "${ENV_FILE}"

: "${DOMAIN:?DOMAIN must be set in ${ENV_FILE}}"
PROD_EXTRA_ALLOWED="${PROD_EXTRA_ALLOWED:-}"

# Build host list: apex + www + extras (comma/space separated), dedup
join_unique_csv() {
  echo "$1" | tr ' ,' '\n' | sed '/^$/d' | awk '!seen[$0]++' | paste -sd',' -
}

BASE="${DOMAIN},www.${DOMAIN}"
ALL_CSV="$(join_unique_csv "${BASE},${PROD_EXTRA_ALLOWED}")"

# CSV -> "a","b","c"
JS_ITEMS="$(awk -v csv="$ALL_CSV" 'BEGIN{
  n=split(csv, a, /,/);
  for(i=1;i<=n;i++){gsub(/^ +| +$/,"",a[i]); if(a[i]!=""){printf "\"%s\"%s", a[i], (i<n?", ":"")}}
}')"

mkdir -p "$(dirname "$OUT")"
sed -e "s|__PROD_ALLOWED_HOSTS__|${JS_ITEMS}|g" "$TPL" > "$OUT"

echo "Rendered ${OUT}"
echo "PROD allowedHosts => [${JS_ITEMS}]"

3) scripts/prod/build_prod.sh
#!/usr/bin/env bash
set -euo pipefail

# Build the PROD frontend image with rendered allowedHosts.
# Reads DOMAIN/PROD_EXTRA_ALLOWED from the same deploy .env you already use.
#
# Usage:
#   scripts/prod/build_prod.sh /absolute/path/to/.env
#
# Requires FRONTEND_IMAGE_NAME in your .env (e.g., socialpredict-frontend).

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
ENV_FILE="${1:-${ENV_PATH:-}}"

if [[ -z "${ENV_FILE}" || ! -f "${ENV_FILE}" ]]; then
  echo "ERROR: Supply path to deploy .env (arg #1) or set ENV_PATH to a valid file." >&2
  exit 1
fi

# shellcheck disable=SC1090
. "${ENV_FILE}"

: "${FRONTEND_IMAGE_NAME:?FRONTEND_IMAGE_NAME must be set in ${ENV_FILE}}"

# 1) Render vite.config.mjs for PROD
"${ROOT_DIR}/scripts/prod/env_writer_prod.sh" "${ENV_FILE}"

# 2) Build the image; since vite.config.mjs is rendered in the build context,
#    your Dockerfile's "npm run build" will pick it up automatically.
docker build \
  -t "${FRONTEND_IMAGE_NAME}:prod" \
  "${ROOT_DIR}/frontend"

echo "Built ${FRONTEND_IMAGE_NAME}:prod"