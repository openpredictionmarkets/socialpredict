# cleanup plan: remove bets/markets dependency on users transaction mutations

## Implementation Plan (Step-by-Step)

1. lock behavior with focused tests
Confirm/expand tests for:
- bets place/sell insufficient-balance mapping
- markets create/resolve insufficient-balance and payout/refund mapping
Run:
`go test ./internal/domain/bets/... ./internal/domain/markets/...`

DONE

2. require wallet in bets call sites
Migrate all construction paths to `bets.NewServiceWithWallet(...)` with a real wallet service.
After call sites are migrated, remove fallback wallet wiring in constructor.
Run:
`go test ./internal/domain/bets/... ./internal/app/...`

DONE

3. remove users mutation dependency from bets service
In `internal/domain/bets/service.go`:
- remove `UserService.ApplyTransaction` dependence
- delete `userWalletAdapter`
- remove legacy users-based wallet fallback
- keep only explicit wallet dependency for balance mutations
Run:
`go test ./internal/domain/bets/...`

DONE

4. migrate bets tests to wallet mocks
Update `internal/domain/bets/service_test.go` and helpers:
- replace user transaction assertions with wallet debit/credit assertions
- remove fake users mutation-only mocks that are no longer needed
Run:
`go test ./internal/domain/bets/...`

DONE

5. require wallet in markets call sites
Migrate all construction paths to `markets.NewServiceWithWallet(...)` with a real wallet service.
After call sites are migrated, remove wallet fallback wiring in constructor.
Run:
`go test ./internal/domain/markets/... ./internal/app/...`

DONE

6. remove legacy users transaction methods from markets interfaces
In `internal/domain/markets/interfaces.go`:
- remove legacy combined `UserService` mutation methods:
  - `ValidateUserBalance`
  - `DeductBalance`
  - `ApplyTransaction`
- keep split interfaces:
  - `CreatorProfileService`
  - `WalletService`
Run:
`go test ./internal/domain/markets/...`

7. delete markets users->wallet adapter
In `internal/domain/markets/service.go`:
- remove adapter methods that call users mutation APIs
- keep explicit wallet dependency only
Run:
`go test ./internal/domain/markets/...`

8. migrate markets tests to split mocks
Update tests using legacy noop/combined user mocks:
- `service_resolve_test.go`
- `service_marketbets_test.go`
- `service_listbystatus_test.go`
Use separate creator/profile and wallet mocks where needed.
Run:
`go test ./internal/domain/markets/...`

9. enforce cleanup with grep checks
Verify no remaining production references in bets/markets to users mutation APIs:
`rg -n "ApplyTransaction\\(|ValidateUserBalance\\(|DeductBalance\\(" internal/domain/bets internal/domain/markets --glob '!**/*_test.go'`
Expected: no matches.

10. full verification + docs checkpoint update
Run:
`go test ./internal/domain/bets/... ./internal/domain/markets/... ./internal/app/... ./handlers/...`
Then update active checkpoint files with final status and boundary notes.

## Definition of Done

- no production code in bets/markets depends on users transaction mutation methods
- all bets/markets balance mutations flow through wallet service
- existing HTTP behavior and insufficient-balance mapping remain unchanged
