# üöÄ Project Plan ‚Äî Merge **incoming-dbpm** branch into `main`
### prepared for **Cline** (Sonnet-4)

---

## 0  Executive Summary
We are replacing the legacy **ratio-based** payout flow with the newer **DBPM valuation** engine from the **incoming-dbpm** branch.  
The merge also introduces security middleware, refactors handlers, and unifies balance updates.  
This plan breaks down the work into **phases**, so Cline can assign, track, and test each piece.

---

## 1  Architecture Decisions (locked)

| Area | Decision |
|------|----------|
| **Payout algorithm** | Keep **DBPM valuations** (`handlers/math/payout/*`) and delete legacy ratio files. |
| **Security** | Adopt the new `security/*` middleware (rate-limit, headers, sanitizer). |
| **Handler layout** | Accept incoming directory moves (`handlers/bets/buying`, `.../selling`, new imports). |
| **Balance updates** | Use `handlers/users/apply_transaction.go` exclusively; deprecate `updatebalanceafterpayout.go`. |
| **Fee model** | Use `BuySharesFee` / `SellSharesFee` as implemented in incoming branch. |
| **Testing** | Retain incoming unit tests; extend as needed after cleanup. |

These decisions are **final** for this project.

---

## 2  Phase Breakdown & Tasks

| Phase | Goal | Key Tasks | Owner | Done-When |
|-------|------|-----------|-------|-----------|
| **P0: Branch prep** | Ensure clean merge base | 1. Pull latest `main`.<br>2. Fast-forward `incoming-dbpm` to current `main`.<br>3. Re-run `go test ./...` on both branches for baseline. | _Dev Lead_ | Both branches have green tests. |
| **P1: Mechanical merge** | Merge code & resolve conflicts | 1. `git merge incoming-dbpm` into a new branch `merge/dbpm-upgrade`.<br>2. For conflicts:<br>&nbsp;&nbsp;‚Ä¢ **Keep** incoming versions of moved/renamed handlers.<br>&nbsp;&nbsp;‚Ä¢ **Remove** legacy ratio payout files:<br>&nbsp;&nbsp;  `handlers/markets/resolvemarket{core,payouts}.go`.<br>&nbsp;&nbsp;‚Ä¢ Delete `handlers/users/updatebalanceafterpayout.go`.<br>3. Run `goimports ./...` and `go mod tidy`. | _Dev Lead_ | Repo builds locally (`go vet ./...`). |
| **P2: Refactor & cleanup** | Remove dead code and dual definitions | 1. Delete unused fee constants from old `feeutils.go`.<br>2. Search/replace old imports (`betshandlers`) ‚Üí new buying/selling packages.<br>3. Remove any dangling ratio-specific tests. | _Core Dev_ | `go test ./...` passes 100 %. |
| **P3: Integration tests** | Verify end-to-end flows | 1. Add/adjust integration tests:<br>&nbsp;&nbsp;‚Ä¢ Buy ‚Üí Sell ‚Üí Resolve ‚Üí DB balances.<br>&nbsp;&nbsp;‚Ä¢ ‚ÄúN/A‚Äù resolution refunds.<br>2. Manual smoke test through Postman (buy, sell, resolve). | _QA_ | Green CI; manual smoke OK. |
| **P4: Security middleware rollout** | Activate new rate-limit & headers | 1. Wire `security/*` into `server.go`.<br>2. Add env toggles (`ENABLE_RATE_LIMIT`, etc.).<br>3. Unit test 429 response. | _DevOps_ | Middleware active in staging. |
| **P5: CI / CD updates** | Prevent dual payout engines in future | 1. Add script that greps for both engine dirs and fails if both exist.<br>2. Ensure Docker build uses new binary path. | _DevOps_ | CI passes, guard in place. |
| **P6: Docs & deprecation** | Communicate changes | 1. Update `README.md` (payout flow diagram).<br>2. Mark old ratio branch as *deprecated ‚Äì merged 2025-07-30*. | _Tech Writer_ | Docs merged; old branch locked. |

---

## 3  Acceptance Criteria

* All unit & integration tests pass in CI (GitHub Actions).
* Resolving a market with **YES** outcome pays integer valuations per DBPM math (verified in DB).
* Resolving with `"N/A"` triggers refunds (balances unchanged).
* POST `/bets/buy` & `/bets/sell` respect `BuySharesFee` / `SellSharesFee`.
* Rate-limit middleware returns HTTP 429 after hitting limit in staging.
* No references to deleted ratio payout code remain (`git grep SelectWinningPositions` returns nothing).
* Docker image builds and runs migrations successfully.

---

## 4  Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Hidden call sites to removed ratio helpers | Build failure | Project-wide grep during P2; CI gate. |
| New middleware rejects legitimate traffic | Service outage | Stage with high limits first; monitor logs. |
| Valuation rounding differences break client UI | Incorrect balances displayed | Extend integration tests to assert UI JSON matches math. |

---

## 5  Timeline (suggested)

| Date | Milestone |
|------|-----------|
| **T + 0 d** | Kick-off, create `merge/dbpm-upgrade` branch. |
| T + 1 d | P1 complete, repo builds. |
| T + 3 d | P2 cleanup & green unit tests. |
| T + 5 d | P3 integration tests green. |
| T + 6 d | P4 middleware live in staging. |
| T + 7 d | Final code review, squash-merge to `main`. |
| T + 8 d | Tag `v0.9.0`, deploy to production. |

---

## 6  Deliverables

* **Merged code** on `main`, commit message: `"feat(payout): switch to DBPM valuations; add security middleware"`.
* **Release notes** summarising payout change and API stability.
* **Deprecation notice** for ratio algorithm.

---

> **Hand-off:**  
> Track phases P0‚ÄìP6 as separate tasks in your board, assign owners above, and auto-close tasks when their ‚ÄúDone-When‚Äù criteria are met.

## Testing

* Ensure tests pass with the command run from backend/ go test ./...
* If not, update code or tests appropriately.

-- Plan --

# SocialPredict DBPM Branch Merge Plan

After analyzing the codebase and patch, I can see we're in the middle of merging the incoming-dbpm branch, with several Git conflicts and architectural changes to complete. Here's my comprehensive execution plan:

## Current State Assessment

__‚úÖ Already Completed:__

- New handler structure created (`handlers/bets/buying/`, `handlers/bets/selling/`)
- DBPM math engine implemented (`handlers/math/payout/`, `handlers/math/positions/`)
- Security middleware framework built (`security/` package)
- New transaction system (`handlers/users/apply_transaction.go`)

__‚ö†Ô∏è Needs Resolution:__

- Git merge conflicts in `server.go` and `apply_transaction.go`
- Import path updates throughout codebase
- Legacy file cleanup
- Test suite updates

## Execution Plan

### Phase 1: Resolve Git Conflicts (Immediate)

1. __Fix server.go routing conflicts__

   - Keep new security middleware wrapping
   - Update bet routes to use `buybetshandlers` and `sellbetshandlers`
   - Ensure all routes have proper security middleware

2. __Complete apply_transaction.go merge__

   - Include SALE, BUY, FEE transaction constants
   - This is critical for the new unified balance system

### Phase 2: Import Path Updates

3. __Update all import references__

   - Change `betshandlers.PlaceBetHandler` ‚Üí `buybetshandlers.PlaceBetHandler`
   - Change `betshandlers.SellPositionHandler` ‚Üí `sellbetshandlers.SellPositionHandler`
   - Update any remaining references to old handler paths

### Phase 3: Legacy Cleanup

4. __Remove legacy payout files__ (as specified in checkpoint):

   - Delete `handlers/markets/resolvemarketcore.go`
   - Delete `handlers/markets/resolvemarketpayouts.go`
   - Delete `handlers/users/updatebalanceafterpayout.go`
   - Ensure these functions are replaced with new DBPM payout logic

5. __Clean up duplicate handlers__

   - Remove old `handlers/bets/placebethandler.go` (replaced by buying version)
   - Remove old `handlers/bets/sellpositionhandler.go` (replaced by selling version)

### Phase 4: Integration & Testing

6. __Run comprehensive test suite__

   - Execute `cd backend && go test ./...`
   - Fix any failing tests due to import changes
   - Ensure DBPM math tests pass

7. __Verify end-to-end flows__

   - Buy ‚Üí Sell ‚Üí Resolve ‚Üí Payout cycle
   - Security middleware functionality
   - New transaction system

## Key Architecture Decisions (Locked)

- __Payout System__: DBPM valuations only (delete ratio-based legacy)
- __Handler Structure__: Separate buying/selling packages
- __Security__: All routes protected by security middleware
- __Balance Updates__: Unified via `ApplyTransactionToUser()` only
- __Transaction Types__: WIN, REFUND, SALE, BUY, FEE constants

## Critical Success Criteria

1. All Git conflicts resolved cleanly
2. `go test ./...` passes 100%
3. All routes have security middleware
4. No references to deleted legacy files
5. DBPM payout math works correctly
6. Frontend compatibility maintained

## Risk Mitigation

- __Import Issues__: Systematic grep/replace of old import paths
- __Test Failures__: Update test imports and mock expectations
- __Breaking Changes__: Verify API response formats unchanged
- __Security__: Ensure all sensitive endpoints properly protected

Would you like me to proceed with executing this plan? The merge conflicts need to be resolved first, then we can systematically work through the cleanup and testing phases.
